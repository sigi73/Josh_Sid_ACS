#include <stdio.h>
#include <stdlib.h>
#include <math.h>

#include "helper_functions.h"
#include "matrix_multiply.h"

float test_case_2_output[] = {
0.          ,  1408.96        ,  2817.92        ,  4226.88        ,  5635.84        ,  7044.8         ,  8453.76        ,  9862.72        , 11271.68        , 12680.64        , 14089.6         , 15498.56        , 16907.52        , 18316.48        , 19725.44        , 21134.4         , 22543.36        ,     0.          ,  4403.          ,  8806.          , 13209.          , 17612.          , 22015.          , 26418.          , 30821.          , 35224.          , 39627.          , 44030.          , 48433.          , 52836.          , 57239.          , 61642.          , 66045.          , 70448.          ,     0.          ,  7397.04        , 14794.08        , 22191.12        , 29588.16        , 36985.2         , 44382.24        , 51779.28        , 59176.32        , 66573.36        , 73970.4         , 81367.44        , 88764.48        , 96161.52        ,103558.56        ,110955.6         ,118352.64        ,     0.          , 10391.08        , 20782.16        , 31173.24        , 41564.32        , 51955.4         , 62346.48        , 72737.56        , 83128.64        , 93519.72        ,103910.8         ,114301.88        ,124692.96        ,135084.04        ,145475.12        ,155866.2         ,166257.28        ,     0.          , 13385.12        , 26770.24        , 40155.36        , 53540.48        , 66925.6         , 80310.72        , 93695.84        ,107080.96        ,120466.08        ,133851.2         ,147236.32        ,160621.44        ,174006.56        ,187391.68        ,200776.8         ,214161.92        ,     0.          , 16379.16        , 32758.32        , 49137.48        , 65516.64        , 81895.8         , 98274.96        ,114654.12        ,131033.28        ,147412.44        ,163791.6         ,180170.76        ,196549.92        ,212929.08        ,229308.24        ,245687.4         ,262066.56        ,     0.          , 19373.2         , 38746.4         , 58119.6         , 77492.8         , 96866.          ,116239.2         ,135612.4         ,154985.6         ,174358.8         ,193732.          ,213105.2         ,232478.4         ,251851.6         ,271224.8         ,290598.          ,309971.2         ,     0.          , 22367.24        , 44734.48        , 67101.72        , 89468.96        ,111836.2         ,134203.44        ,156570.68        ,178937.92        ,201305.16        ,223672.4         ,246039.64        ,268406.88        ,290774.12        ,313141.36        ,335508.6         ,357875.84        ,     0.          , 25361.28        , 50722.56        , 76083.84        ,101445.12        ,126806.4         ,152167.68        ,177528.96        ,202890.24        ,228251.52        ,253612.8         ,278974.08        ,304335.36        ,329696.64        ,355057.92        ,380419.2         ,405780.48        ,     0.          , 28355.32        , 56710.64        , 85065.96        ,113421.28        ,141776.6         ,170131.92        ,198487.24        ,226842.56        ,255197.88        ,283553.2         ,311908.52        ,340263.84        ,368619.16        ,396974.48        ,425329.7999999999,453685.1199999999,     0.          , 31349.36        , 62698.72        , 94048.08        ,125397.44        ,156746.8         ,188096.16        ,219445.52        ,250794.88        ,282144.24        ,313493.6         ,344842.96        ,376192.3200000001,407541.6799999999,438891.04        ,470240.4         ,501589.76        ,     0.          , 34343.4         , 68686.8         ,103030.2         ,137373.6         ,171716.9999999999,206060.4         ,240403.8         ,274747.2         ,309090.6         ,343433.9999999999,377777.4         ,412120.8         ,446464.2         ,480807.6         ,515151.          ,549494.4         ,     0.          , 37337.44        , 74674.88        ,112012.32        ,149349.76        ,186687.2         ,224024.64        ,261362.08        ,298699.52        ,336036.96        ,373374.4         ,410711.84        ,448049.28        ,485386.72        ,522724.16        ,560061.6         ,597399.0399999999,     0.          , 40331.48        , 80662.96        ,120994.44        ,161325.92        ,201657.4         ,241988.88        ,282320.36        ,322651.84        ,362983.32        ,403314.7999999999,443646.2799999999,483977.7600000001,524309.24        ,564640.72        ,604972.2000000001,645303.6799999999,     0.          , 43325.52        , 86651.04        ,129976.56        ,173302.08        ,216627.6         ,259953.12        ,303278.64        ,346604.16        ,389929.6800000001,433255.2         ,476580.72        ,519906.24        ,563231.76        ,606557.28        ,649882.7999999999,693208.3200000001,     0.          , 46319.56        , 92639.12        ,138958.68        ,185278.24        ,231597.8         ,277917.36        ,324236.92        ,370556.48        ,416876.04        ,463195.6         ,509515.16        ,555834.72        ,602154.28        ,648473.84        ,694793.4         ,741112.96        ,     0.          , 49313.6         , 98627.2         ,147940.8         ,197254.4         ,246568.          ,295881.6         ,345195.2         ,394508.8         ,443822.4         ,493135.9999999999,542449.6         ,591763.2         ,641076.8         ,690390.4         ,739704.          ,789017.6
};

#define EPSILON 0.1

int check_float_mat_equal(float *m1, float *m2, int rows, int cols)
{
    for (int i = 0; i < rows; i++)
    {
        for (int j = 0; j < cols; j++)
        {
            if (fabs(m1[i*cols+j] - m2[i*cols+j]) > EPSILON)
            {
                printf("i:%d,j:%d, 1:%f,2:%f\n", i, j, m1[i*cols+j], m2[i*cols+j]);
                return 0;
            }
        }
    }
    return 1;
}

int test_mult(float *m1, int r1, int c1, float *m2, int r2, int c2, int block_size, float *expected_result)
{
    float *result = create_float_mat(r1, c2);
    int output = 1;

    multiply_float_naive(m1, r1, c1, m2, r2, c2, result);
    int res = check_float_mat_equal(result, expected_result, r1, c2);
    if (res == 0)
    {
        output = 0;
        fprintf(stderr, "Naive failed\n");
    }
    clear_float_mat(result, r1, c2);

    multiply_float_block(m1, r1, c1, m2, r2, c2, block_size, result);
    res = check_float_mat_equal(result, expected_result, r1, c2);
    if (res == 0)
    {
        output = 0;
        fprintf(stderr, "Block failed\n");
    }
    clear_float_mat(result, r1, c2);

    multiply_float_simd(m1, r1, c1, m2, r2, c2, result);
    res = check_float_mat_equal(result, expected_result, r1, c2);
    if (res == 0)
    {
        output = 0;
        fprintf(stderr, "SIMD Failed\n");
    }
    clear_float_mat(result, r1, c2);

    return output;
}

// Test short matrix matrix multiplication
void main()
{
    int SIZE;
    float *m1, *m2, *expected_result; 
    int output;

    SIZE = 17;

    m1 = create_float_mat(SIZE, SIZE);
    m2 = create_float_mat(SIZE, SIZE);
    expected_result = create_float_mat(SIZE, SIZE);

    for (int i = 0; i < SIZE*SIZE; i++)
    {
        m1[i] = 1.1;
        m2[i] = 2.5;
        expected_result[i] = 46.75;
    }
    output = test_mult(m1, SIZE, SIZE, m2, SIZE, SIZE, 4, expected_result);
    if (output == 0)
    {
        printf("Error in test case 1\n");
    }
    else
    {
        printf("Test case 1 passed\n");
    }

    for (int i = 0; i < SIZE*SIZE; i++)
    {
        m1[i] = i*2.8;
        m2[i] = (i % SIZE)*3.7;
    }
    output = test_mult(m1, SIZE, SIZE, m2, SIZE, SIZE, 4, test_case_2_output);
    if (output == 0)
    {
        printf("Error in test case 2\n");
    }
    else
    {
        printf("Test case 2 passed\n");
    }
}